<!DOCTYPE html>
<html lang="pl">
<head>
<title>Galaktyczne Biznesy</title>
<meta charset="utf-8" />
<link rel="stylesheet" href="globalne.css">
<link rel="stylesheet" href="kolory.css">
<link rel="stylesheet" href="mapa.css">
<script src="funkcjeTla.js"></script>
<script src="funkcjeMenu.js"></script>
<script src="funkcjeKodowania.js"></script>
<script src="funkcjeRysowania.js"></script>
<script type="text/javascript">
	const koloryPlanet=["#e3392f","#f7574d","#f77f6b","#f7b175","#f7edb1","#f7894d","#f7bbb1","#b1e3f7","#e3f7f7","#cfedf7","#f7e339","#f7f793"]
	let polozenie=[[350,350]]
	function start()
	{
		tlo.zaladuj()
		menu.zaladuj()
		document.getElementById("kontent").appendChild(ekran.mapa.div)
		document.getElementById("kontent").appendChild(ekran.uklad.div)
		setTimeout(()=>{menu.guziki[0][2].odswiez({aktywny:1,menu:'test',zaznaczony:1})},4000)
		setTimeout(()=>{menu.guziki[0][1].odswiez({aktywny:1,funkcja:'document.write(raportuj.drukuj())',zaznaczony:0})},4000)
		setTimeout(()=>{zaznaczUklad(352,352)},500)
	}
	class Ekran
	{
		constructor(nazwa)
		{
			this.nazwa=nazwa
			this.div=document.createElement("div")
	    	this.div.className="ekran"
	    	this.div.id=`ekran-${nazwa}`
	    	//
	    	this.stan=0
	    	this.zmiana=0
	    	this.aktywny=1
	    	//
			this.tlo={obraz:0,canvas:document.createElement("canvas")}
			this.tlo.canvas.className="ekranWypelnienie"
			this.obraz_1={obraz:0,canvas:document.createElement("canvas")}
			this.obraz_1.canvas.className="ekranWypelnienie"
			this.obraz_2={obraz:0,canvas:document.createElement("canvas")}
			this.obraz_2.canvas.className="ekranWypelnienie"
			this.interaktywne={elementy:0,div:document.createElement("div")}
			this.interaktywne.div.className="ekranWypelnienie"
			this.dotyk={elementy:[],div:document.createElement("div")}
			this.dotyk.div.className="ekranWypelnienie"
			//
			this.narozniki=[]
	    	for (let i=0 ; i<4 ; i++)
	    	{
	    		const naroznik={}
	    		naroznik.div=document.createElement("div")
	    		naroznik.div.style.position="absolute"
	    		naroznik.div.style.transition="0.3s"
	    		naroznik.div.style.width="15%"
	    		naroznik.div.style.height="15%"
	    		naroznik.strony=[]
	    		naroznik.strony.push(`${["Left","Right"][i%2]}`)
	    		naroznik.strony.push(`${["Top","Bottom"][Math.floor(i/2)]}`)
	    		for (const strona of naroznik.strony)
	    		{
	    			naroznik.div.style[`border${strona}`]=`solid 0.5vh var(--podstawowy1)`
	    		}
	    		this.narozniki.push(naroznik)
	    		this.div.appendChild(naroznik.div)
	    	}
	    	this.div.appendChild(this.tlo.canvas)
	    	this.div.appendChild(this.obraz_1.canvas)
	    	this.div.appendChild(this.obraz_2.canvas)
	    	this.div.appendChild(this.interaktywne.div)
	    	this.div.appendChild(this.dotyk.div)
	    	//
	    	this.nadajStan(0)
		}
		nadajStan(stan)
		{
			if (this.zmiana){console.log("nie można zmienić stanu ekranu bo nie zakończyła się poprzednia zmiana");return}
			if (stan!=0 && stan!=1){console.log("błąd");return}
			this.stan=stan
			this.zmiana=1
			this.dotyk.div.innerHTML=""
			//
			if (stan){this.nadanieWypelnienia()}
			setTimeout(()=>{this.krycieWypelnienia(stan)},[1,310][stan])
			setTimeout(()=>{this.stanNaroznikow(stan)},[50,1][stan])
			setTimeout(()=>{this.zmiana=0},350)
		}
		krycieWypelnienia(stan)
		{
			this.tlo.canvas.style.opacity=stan
			this.obraz_1.canvas.style.opacity=stan
			this.obraz_2.canvas.style.opacity=stan
			this.interaktywne.div.style.opacity=stan
			this.dotyk.div.style.opacity=stan
		}
		stanNaroznikow(stan)
		{
			for (const naroznik of this.narozniki)
	    	{
	    		for (const strona of naroznik.strony)
	    		{
	    			naroznik.div.style[strona.toLowerCase()]=[`42%`,"-0.7%"][stan]
	    		}
	    	}
		}
		nadanieWypelnienia()
		{
			if ((this.obraz_1.obraz||{elementy:[]}).elementy.length){rysuj(this.obraz_1.canvas,this.obraz_1.obraz)}
			if ((this.obraz_2.obraz||{elementy:[]}).elementy.length){rysuj(this.obraz_2.canvas,this.obraz_2.obraz)}
			this.interaktywne.div.innerHTML=""
			if ((this.interaktywne.elementy||[]).length){console.log("do uzupełnienia")}
			this.dotyk.div.innerHTML=""
			this.aktywny=1
			for (let i=0 ; i<(this.dotyk.elementy||[]).length ; i++)
			{
				const zaznacznik=document.createElement("div")
	    		zaznacznik.className="zaznacznik"
	    		zaznacznik.style.top=`${this.dotyk.elementy[i].y}%`
	    		zaznacznik.style.left=`${this.dotyk.elementy[i].x}%`
	    		zaznacznik.onclick = new Function(`ekran.${this.nazwa}.uruchom(${i})`)
				this.dotyk.div.appendChild(zaznacznik)
			}
		}
		uruchom(nr)
		{
			if (!this.aktywny){return}
			this.aktywny=0
			if (typeof this.dotyk.elementy[nr].funkcja=="string")
			{
				new Function(this.dotyk.elementy[nr].funkcja)()
			}
			else if (typeof this.dotyk.elementy[nr].funkcja=="function")
	    	{
	    		this.dotyk.elementy[nr].funkcja()
	    	}
	    	else
	    	{
	    		console.log("nieznany typ funkcji")
	    	}
		}
	}
	const ekran=
	{
		mapa: new Ekran("mapa"),
		uklad: new Ekran("uklad"),
	}
	function zaznaczUklad(y,x)
	{
		if (!(y>-1 && y<700 && x>-1 && x<700)){return}
		polozenie.unshift([y,x])
		polozenie=polozenie.slice(0,57)
		uzupelnianieDanych.wygladUkladow(y-19,y+19,x-19,x+19)
		setTimeout(()=>
		{
			ekran.mapa.nadajStan(0)
			ekran.uklad.nadajStan(0)
			pokaz.mape()
			pokaz.minimape()
		},150)
	}
	pokaz=
	{
		mape:function(proba)
		{
			proba=proba||1
			if (proba>27){console.log("ładowanie mapy nie powiodło się");return}
			const lista=uzupelnianieDanych.wygladUkladow(polozenie[0][0]-2,polozenie[0][0]+2,polozenie[0][1]-2,polozenie[0][1]+2,77)
			if (!Array.isArray(lista)){return setTimeout(()=>{pokaz.mape(proba+1)},300)}
			//
			ekran.mapa.dotyk.elementy=[]
			const elementy=[]
			const korekta=[0,0]
			for (let uklad of lista)
			{
				if (uklad.y==polozenie[0][0] && uklad.x==polozenie[0][1])
				{
					if (!(uklad.przesuniecie>0)){break}
					const procent=realnePolozenieUkladu(uklad.y,uklad.x,uklad.przesuniecie)
					for (let i=0 ; i<2 ; i++)
					{
						//console.log(`${"YX"[i]}: ${0.5-procent[i]}`)
						korekta[i]=Math.round((0.5-procent[i])*100)/100
						if (korekta[i]>0.15)
						{
							korekta[i]=0.15
						}
						else if (korekta[i]<-0.15)
						{
							korekta[i]=-0.15
						}
					}
				}
			}
			console.log(korekta)
			for (let uklad of lista)
			{
				if (uklad.wielkosc<1 || uklad.przesuniecie<1){continue}
				const wzgledneY=(uklad.y-polozenie[0][0])+2
				const wzgledneX=(uklad.x-polozenie[0][1])+2
				if (!(wzgledneY>=0 && wzgledneY<5 && wzgledneX>=0 && wzgledneX<5))
				{
					console.log(`błąd: ${wzgledneY} - ${wzgledneY}`)
					continue
				}
				const procent=realnePolozenieUkladu(uklad.y,uklad.x,uklad.przesuniecie)
				const srodek=[140*wzgledneY+140*(procent[0]+korekta[0]),140*wzgledneX+140*(procent[1]+korekta[1])]
				elementy.push({kolor:koloryPlanet[uklad.kolor],srodek:srodek,promien:uklad.wielkosc+2})
				if (uklad.y!=polozenie[0][0] || uklad.x!=polozenie[0][1])
				{
					ekran.mapa.dotyk.elementy.push({y:wzgledneY*20+((procent[0]+korekta[0])*20),x:wzgledneX*20+((procent[1]+korekta[1])*20),funkcja:`zaznaczUklad(${uklad.y},${uklad.x})`})
					if (uklad.iloscPlanet<1){debugger}
					for (let i=0 ; i<uklad.iloscPlanet ; i++)
					{
						//dodawanie planet
						const zakresKatow=[]
						zakresKatow[0]=Math.random()*2
						zakresKatow[1]=zakresKatow[0]+(Math.random()*0.25)+(1.7/((i+1)*2))
						if (zakresKatow[1]>2){zakresKatow[1]-=2}
						elementy.push({kolorLini:"#393939",grubosc:1,srodek:srodek,promien:(uklad.wielkosc+2)+(i*4)+5,zakresKatow:zakresKatow})
					}
				}
			}
			ekran.mapa.obraz_1.obraz={h:700,d:700,elementy:elementy}
			//
			setTimeout(()=>{ekran.mapa.nadajStan(1)},370)
		},
		minimape:function(proba)
		{
			proba=proba||1
			if (proba>20){console.log("ładowanie mapy nie powiodło się");return}
			const lista=uzupelnianieDanych.wygladUkladow(polozenie[0][0]-17,polozenie[0][0]+17,polozenie[0][1]-17,polozenie[0][1]+17,77)
			if (!Array.isArray(lista)){return setTimeout(()=>{pokaz.minimape(proba+1)},400)}
			//
			if (true)
			{
				const elementy=[]
				elementy[0]={kolorLini:"green",punkty:[[300,320],[300,300],[320,300],[400,380],[400,400],[380,400]],grubosc:3}
				elementy[1]={kolorLini:"green",punkty:[[380,300],[400,300],[400,320],[320,400],[300,400],[300,380]],grubosc:3}
				elementy[2]={kolor:"black",punkty:[[302,302],[302,398],[398,398],[398,302]]}
				ekran.uklad.tlo.obraz={h:700,d:700,elementy:elementy}
				rysuj(ekran.uklad.tlo.canvas,ekran.uklad.tlo.obraz)
			}
			//
			ekran.uklad.dotyk.elementy=[]
			const elementy=[]
			for (let uklad of lista)
			{
				if (uklad.wielkosc<1 || uklad.przesuniecie<1){continue}
				const wzgledneY=(uklad.y-polozenie[0][0])+17
				const wzgledneX=(uklad.x-polozenie[0][1])+17
				if (!(wzgledneY>=0 && wzgledneY<35 && wzgledneX>=0 && wzgledneX<35))
				{
					console.log(`błąd: ${wzgledneY} - ${wzgledneY}`)
					continue
				}
				const procent=realnePolozenieUkladu(uklad.y,uklad.x,uklad.przesuniecie)
				elementy.push({kolor:"white",srodek:[20*wzgledneY+20*procent[0],20*wzgledneX+20*procent[1]],promien:(uklad.wielkosc/2)})
			}
			ekran.uklad.obraz_1.obraz={h:700,d:700,elementy:elementy}
			//
			setTimeout(()=>{ekran.uklad.nadajStan(1)},370)
		},
		siatka(canvas,margines,oczko,kolor)
		{
			//
		}
	}
	uzupelnianieDanych=
	{
		wygladUkladow:function(Ystart,Ykoniec,Xstart,Xkoniec,proba)
		{
			if (!(Ykoniec-Ystart>0 && Ykoniec-Ystart<51)){console.log("błąd");console.log(Ystart,Ykoniec,Xstart,Xkoniec);return}
			if (!(Xkoniec-Xstart>0 && Xkoniec-Xstart<51)){console.log("błąd");console.log(Ystart,Ykoniec,Xstart,Xkoniec);return}
			proba=proba||1
			const obecne=[]
			const nieobecne=[]
			for (let y=Ystart ; y<Ykoniec+1 ; y++)
			{
				for (let x=Xstart ; x<Xkoniec+1 ; x++)
				{
					const uklad=pamiec.szukaj.wygladUkladow(y,x)
					if (uklad)
					{
						uklad.y=y
						uklad.x=x
						obecne.push(uklad)
					}
					else
					{
						nieobecne.push([y,x])
					}
				}
			}
			if (nieobecne.length>0)
			{
				if (proba<4)
				{
					serwer.pytaj.wygladUkladow(nieobecne)
					setTimeout(()=>{uzupelnianieDanych.wygladUkladow(Ystart,Ykoniec,Xstart,Xkoniec,proba+1)},5000)
				}
				return 0
			}
			return obecne
		}
	}
	serwer=
	{
		pytaj:
		{
			wygladUkladow:function(lista)
			{
				let zwrotka=""
				for (uklad of lista)
				{
					//funkcja testowa, losuje ukłądy i zwraca jak serwer
					let s;
					if (!(uklad[0]>-1 && uklad[0]<700 && uklad[1]>-1 && uklad[1]<700))
					{
						//kiedy pytanie o ukłąd poza planszą zwraca brak
						s=koduj.wygladUkladu(uklad[0],uklad[1],0,0,0,0)
					}
					else
					{
						s=koduj.wygladUkladu(uklad[0],uklad[1],los(0,3),los(0,9),los(0,11),los(1,7))
					}
					zwrotka+=s
				}
				setTimeout(()=>{serwer.odbierz.wygladUkladow(zwrotka)},200+Math.random()*300)
			}
		},
		odbierz:
		{
			wygladUkladow:function(lista)
			{
				console.log(`serwer wysłał ${lista.length/6} układów`)
				for (let i=0 ; i<lista.length ; i+=6)
				{
					let s=""
					for (let j=0 ; j<6 ; j++)
					{
						s+=lista[i+j]
					}
					pamiec.dodaj.wygladUkladow(s)
				}
			}
		}
	}
	pamiec=
	{
		pamiec:
		{
			wygladUkladow:[[],[],[],[],[],[],[],[],[]]
		},
		adres:
		{
			wygladUkladow(y,x)
			{
				const nrListy=(Math.floor((y%150)/50)*3)+Math.floor((x%150)/50)
				const pozycja=((y%50)*50)+(x%50)
				return {nrListy:nrListy,pozycja:pozycja}
			}
		},
		dodaj:
		{
			wygladUkladow:function(s)
			{
				const uklad=odkoduj.wygladUkladu(s)
				const {nrListy,pozycja}=pamiec.adres.wygladUkladow(uklad.y,uklad.x)
				pamiec.pamiec.wygladUkladow[nrListy][pozycja]={y:uklad.y,x:uklad.x,uklad:s}
			}
		},
		szukaj:
		{
			wygladUkladow:function(y,x)
			{
				const {nrListy,pozycja}=pamiec.adres.wygladUkladow(y,x)
				let uklad=pamiec.pamiec.wygladUkladow[nrListy][pozycja]
				if (!uklad || typeof uklad!="object"){return 0}
				if (!(uklad.y==y && uklad.x==x)){return 0}
				uklad=odkoduj.wygladUkladu(uklad.uklad)
				return uklad
			}
		},
	}
	function realnePolozenieUkladu(y,x,przesuniecie)
	{
		// y i x to położenie na planszy
		// przesunięcie to wartość przypisana dla układu od 1 do 9 włącznie (9 możliwości)
		const q=[[0,2],[1,1],[2,2],[0,0],[1,2],[2,0],[0,1],[1,0],[2,1]]//schemat przesunięć
		const nr=((y%3)*3)+x%3
		// nr to jedno z 9 przesunięć zależne od położenia na planszy
		const zwrotka=[]
		const mnozniki=[11,20]//%
		const margines=50-(mnozniki[0]+mnozniki[1])//% (margines nie może być mniejszy niż 15%)
		zwrotka[0]=margines+(q[nr][0]*mnozniki[0])+(q[przesuniecie-1][0]*mnozniki[1])
		zwrotka[1]=margines+(q[nr][1]*mnozniki[0])+(q[przesuniecie-1][1]*mnozniki[1])
		zwrotka[0]=Math.round((zwrotka[0])*100)/10000
		zwrotka[1]=Math.round((zwrotka[1])*100)/10000
		// wartość zwrotki będzie zaokrąglona do 2 miejsc po przecinku
		// wartość zwrotki jest procentowa i oznacza przesunięcie w polu od lewego górnego narożnika
		return zwrotka
	}
	function los(min,max)
	{
		let l=Math.random()*((max-min)+1)
		l+=min
		return Math.floor(l)
	}
</script>
</head>
<body onload="start()">
	<div id="tlo"></div>
	<div id="kontent"></div>
	<div id="sztucznaStopka"></div>
	<div class="pas" id="pas1"><div class="kontentPas"></div></div></div>
	<div class="pas" id="pas2"><div class="kontentPas"></div></div></div>
	<div id="oknoMenu"><div id="tloMenu"></div><div id="ramyMenu"><div id="ramaMenu1"></div><div id="ramaMenu2"></div></div><div id="kontentMenu"></div></div>
</body>
</html>
