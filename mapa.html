<!DOCTYPE html>
<html lang="pl">
<head>
<title>Galaktyczne Biznesy</title>
<meta charset="utf-8" />
<link rel="stylesheet" href="globalne.css">
<link rel="stylesheet" href="kolory.css">
<link rel="stylesheet" href="mapa.css">
<script src="funkcjeTla.js"></script>
<script src="funkcjeMenu.js"></script>
<script src="funkcjeKodowania.js"></script>
<script src="funkcjeRysowania.js"></script>
<script type="text/javascript">
	const koloryPlanet=["#e31107","#e33907","#e34d07","#e37507","#ed9d07","#f7cf07","#f7ed07","#f7ed4d","#f7edb1","#e3e3f7","#89e3f7","#397ff7"]
	const polozenie=[[350,350]]
	const zapisane=
	{
		widokiUkladow:JSON.parse(localStorage.getItem("zapisane.widokiUkladow")||"0")||[[],[],[],[],[],[],[],[],[]]
	}
	function start()
	{
		tlo.zaladuj()
		menu.zaladuj()
		document.getElementById("kontent").appendChild(ekran.mapa.div)
		document.getElementById("kontent").appendChild(ekran.uklad.div)
		setTimeout(()=>{menu.guziki[0][2].odswiez({aktywny:1,menu:'test',zaznaczony:1})},4000)
		setTimeout(()=>{zaznaczUklad(352,352)},1000)
	}
	class Ekran
	{
	    constructor(nazwa)
	    {
	    	this.obraz=[]
	    	this.dotyki=[{y:40,x:40,funkcja:function(){console.log("test")}}]//lista {y:położenie%,x:polozenie%,funkcja:funkcja po kliknięciu}
	    	this.stan=0
	    	this.div=document.createElement("div")
	    	this.div.className="ekran"
	    	this.div.id=`ekran-${nazwa}`
	    	//
	    	this.narozniki=[]
	    	for (let i=0 ; i<4 ; i++)
	    	{
	    		const naroznik={}
	    		naroznik.div=document.createElement("div")
	    		naroznik.div.style.position="absolute"
	    		naroznik.div.style.transition="0.4s"
	    		naroznik.div.style.width="15%"
	    		naroznik.div.style.height="15%"
	    		naroznik.strony=[]
	    		naroznik.strony.push(`${["Left","Right"][i%2]}`)
	    		naroznik.strony.push(`${["Top","Bottom"][Math.floor(i/2)]}`)
	    		for (const strona of naroznik.strony)
	    		{
	    			naroznik.div.style[`border${strona}`]=`solid 0.5vh var(--podstawowy1)`
	    		}
	    		for (const strona of naroznik.strony)
	    		{
	    			naroznik.div.style[strona.toLowerCase()]=[`42%`,"-0.7%"][this.stan]
	    		}
	    		this.narozniki.push(naroznik)
	    		this.div.appendChild(naroznik.div)
	    	}
	    	this.canvas=[]
	    	for (let i=0 ; i<3 ; i++)
	    	{
	    		this.canvas[i]=document.createElement("canvas")
				this.canvas[i].className="ekran-canvas"
				this.canvas[i].id=`${nazwa}-canvas`
				this.canvas[i].style.opacity=this.stan
				this.div.appendChild(this.canvas[i])
	    	}
	    	if (true)
	    	{
	    		this.divDotyk=document.createElement("div")
	    		this.divDotyk.className="divDotyk"
	    		this.div.appendChild(this.divDotyk)
	    	}
	    }
	    zamknij()
	    {
	    	this.stan=0
	    	this.dopasujStan()
	    }
	    otworz()
	    {
	    	this.stan=1
	    	this.dopasujStan()
	    }
	    dopasujStan()
	    {
	    	this.divDotyk.innerHTML=""
	    	setTimeout(()=>{for(let i=0 ; i<3 ; i++){this.canvas[i].style.opacity=this.stan}},[1,410][this.stan])
	    	if (this.stan)
	    	{
	    		for (let i=0 ; i<3 ; i++)
	    		{
	    			if (this.obraz[i])
	    			{
	    				rysuj(this.canvas[i],this.obraz[i])
	    			}
	    		}
	    		for (let i=0 ; i<this.dotyki.length ; i++)
	    		{
	    			const zaznacznik=document.createElement("div")
	    			zaznacznik.className="zaznacznik"
	    			zaznacznik.style.top=`${this.dotyki[i].y}%`
	    			zaznacznik.style.left=`${this.dotyki[i].x}%`
	    			zaznacznik.onclick=this.dotyki[i].funkcja
	    			setTimeout(()=>{this.divDotyk.appendChild(zaznacznik)},[1,50][this.stan])
	    		}
	    	}
	    	for (const naroznik of this.narozniki)
	    	{
	    		for (const strona of naroznik.strony)
	    		{
	    			setTimeout(()=>{naroznik.div.style[strona.toLowerCase()]=[`42%`,"-0.7%"][this.stan]},[50,1][this.stan])
	    		}
	    	}
	    }
	    odswiez()
	    {
	    	this.zamknij()
	    	setTimeout(()=>{this.otworz()},600)
	    }
	}
	const ekran=
	{
		mapa: new Ekran("mapa"),
		uklad: new Ekran("uklad"),
	}
	function zaznaczUklad(y,x)
	{
		polozenie.unshift([y,x])
		let lista=[]
		for (let a=0 ; a<39 ; a++)
		{
			for (let b=0 ; b<39 ; b++)
			{
				if (!szukajWygladuUkladu((polozenie[0][0]-19)+a,(polozenie[0][1]-19)+b))
				{
					lista.push([(polozenie[0][0]-19)+a,(polozenie[0][1]-19)+b])
				}
			}
		}
		zapytajSerwer.wygladUkladow(lista)
		lista=[]
		setTimeout(()=>{ekran.mapa.zamknij()},400)
		setTimeout(pokaz.mape,450)
		setTimeout(()=>{ekran.uklad.zamknij()},400)
		setTimeout(pokaz.minimape,450)
	}
	const pokaz=
	{
		mape:function()
		{
			const widoczneUklady=[]
			const pole=700/5
			for (let y=0 ; y<5 ; y++)
			{
				for (let x=0 ; x<5 ; x++)
				{
					const Y=(polozenie[0][0]-2)+y
					const X=(polozenie[0][1]-2)+x
					let uklad=szukajWygladuUkladu(Y,X)
					if (uklad)
					{
						uklad=odkoduj.wygladUkladu(uklad)
						if (uklad.wielkosc>0 && uklad.przesuniecie>0)
						{
							const procent=realnePolozenie(Y,X,uklad.przesuniecie,pole)
							uklad.polozenie=[Y,X]
							uklad.polozenieWidok=[]
							uklad.polozenieWidok[0]=(y*pole)+(procent[0]*pole)
							uklad.polozenieWidok[1]=(x*pole)+(procent[1]*pole)
							uklad.polozenieWidokProcent=[]
							uklad.polozenieWidokProcent[0]=(y*20)+(procent[0]*20)
							uklad.polozenieWidokProcent[1]=(x*20)+(procent[1]*20)
							widoczneUklady.push(uklad)
						}
					}
					else
					{
						return setTimeout(pokaz.mape,500)
					}
				}
			}
			if (!ekran.mapa.obraz[0])
			{
				const elementy=[]
				elementy.push({typ:1,punkty:[[14,686],[686,686],[686,14],[14,14]],grubosc:27,kolorLini:"#253911",krycie:0.2})
				elementy.push({typ:1,punkty:[[27,27],[673,27],[673,673],[27,673]],kolor:"#000000",krycie:0.4})
				if (true)
				{
					for (let a=0 ; a<9 ; a++)
					{
						const element={typ:1,punkty:[],grubosc:2,kolorLini:"#253911"}
						element.punkty.push([27,27+(a*38)])
						element.punkty.push([27,673-(a*38)])
						element.punkty.push([673,673-(a*38)])
						element.punkty.push([673,27+(a*38)])
						elementy.push(element)
					}
					for (let a=0 ; a<9 ; a++)
					{
						const element={typ:1,punkty:[],grubosc:2,kolorLini:"#253911"}
						element.punkty.push([27+(a*38),27])
						element.punkty.push([673-(a*38),27])
						element.punkty.push([673-(a*38),673])
						element.punkty.push([27+(a*38),673])
						elementy.push(element)
					}
				}
				ekran.mapa.obraz[0]={h:700,d:700,elementy:elementy}
			}
			if (true)
			{
				const elementy=[]
				for (let uklad of widoczneUklady)
				{
					elementy.push({typ:0,kolor:koloryPlanet[uklad.kolor],srodek:uklad.polozenieWidok,promien:(uklad.wielkosc*1.2)+2,rozmycie:(uklad.wielkosc*1.5),krycie:1})
					elementy.push({typ:0,kolor:koloryPlanet[uklad.kolor],srodek:uklad.polozenieWidok,promien:uklad.wielkosc+2})
				}
				ekran.mapa.obraz[2]={h:700,d:700,elementy:elementy}
				ekran.mapa.dotyki=[]
				for (let uklad of widoczneUklady)
				{
					ekran.mapa.dotyki.push({y:uklad.polozenieWidokProcent[0],x:uklad.polozenieWidokProcent[1],funkcja:function(){zaznaczUklad(uklad.polozenie[0],uklad.polozenie[1])}})
				}
				setTimeout(()=>{ekran.mapa.otworz()},600)
			}
		},
		minimape:function()
		{
			const widoczneUklady=[]
			const pole=700/35
			for (let y=0 ; y<35 ; y++)
			{
				for (let x=0 ; x<35 ; x++)
				{
					const Y=(polozenie[0][0]-17)+y
					const X=(polozenie[0][1]-17)+x
					let uklad=szukajWygladuUkladu(Y,X)
					if (uklad)
					{
						uklad=odkoduj.wygladUkladu(uklad)
						if (uklad.wielkosc>0 && uklad.przesuniecie>0)
						{
							const procent=realnePolozenie(Y,X,uklad.przesuniecie,pole)
							uklad.polozenie=[Y,X]
							uklad.polozenieWidok=[]
							uklad.polozenieWidok[0]=(y*pole)+(procent[0]*pole)
							uklad.polozenieWidok[1]=(x*pole)+(procent[1]*pole)
							widoczneUklady.push(uklad)
						}
					}
					else
					{
						return setTimeout(pokaz.minimape,500)
					}
				}
			}
			if (!ekran.uklad.obraz[0])
			{
				const elementy=[]
				elementy.push({typ:1,punkty:[[14,686],[686,686],[686,14],[14,14]],grubosc:27,kolorLini:"#253911",krycie:0.2})
				if (true)
				{
					for (let a=0 ; a<20 ; a++)
					{
						const element={typ:1,punkty:[],grubosc:2,kolorLini:"#111b07"}
						element.punkty.push([27,27+(a*17)])
						element.punkty.push([27,673-(a*17)])
						element.punkty.push([673,673-(a*17)])
						element.punkty.push([673,27+(a*17)])
						elementy.push(element)
					}
					for (let a=0 ; a<20 ; a++)
					{
						const element={typ:1,punkty:[],grubosc:2,kolorLini:"#111b07"}
						element.punkty.push([27+(a*17),27])
						element.punkty.push([673-(a*17),27])
						element.punkty.push([673-(a*17),673])
						element.punkty.push([27+(a*17),673])
						elementy.push(element)
					}
				}
				elementy.push({typ:1,punkty:[[300,300],[300,400],[400,400],[400,300]],kolor:"#000000"})
				elementy.push({typ:1,punkty:[[300,300],[300,400],[400,400],[400,300]],grubosc:2,kolorLini:"#4df707"})
				ekran.uklad.obraz[0]={h:700,d:700,elementy:elementy}
			}
			if (true)
			{
				const elementy=[]
				for (let uklad of widoczneUklady)
				{
					elementy.push({typ:0,kolor:koloryPlanet[uklad.kolor],srodek:uklad.polozenieWidok,promien:(uklad.wielkosc/2)+1,rozmycie:2})
				}
				ekran.uklad.obraz[2]={h:700,d:700,elementy:elementy}
				ekran.uklad.dotyki=[]
				setTimeout(()=>{ekran.uklad.otworz()},600)
			}
		},
		szczegolyMapy:function()
		{
			//
		}
	}
	function realnePolozenie(y,x,przesuniecie)
	{
		// y i x to położenie na planszy
		// przesunięcie to wartość przypisana dla układu od 1 do 9 włącznie (9 możliwości)
		const q=[[0,2],[1,1],[2,2],[0,0],[1,2],[2,0],[0,1],[1,0],[2,1]]//schemat przesunięć
		const nr=((y%3)*3)+x%3
		// nr to jedno z 9 przesunięć zależne od położenia na planszy
		const zwrotka=[]
		const mnozniki=[15,25]//%
		const margines=50-(mnozniki[0]+mnozniki[1])//% (nie może być mniejszy niż 0)
		zwrotka[0]=margines+(q[nr][0]*mnozniki[0])+(q[przesuniecie-1][0]*mnozniki[1])
		zwrotka[1]=margines+(q[nr][1]*mnozniki[0])+(q[przesuniecie-1][1]*mnozniki[1])
		zwrotka[0]=Math.round((zwrotka[0])*100)/10000
		zwrotka[1]=Math.round((zwrotka[1])*100)/10000
		// wartość zwrotki będzie zaokrąglona do 2 miejsc po przecinku
		// wartość zwrotki jest procentowa i oznacza przesunięcie w polu od lewego górnego narożnika
		return zwrotka
	}
	function szukajWygladuUkladu(y,x)
	{
		if(!(y>-1 && y>-1 && y<700 && y<700 && x>-1 && x>-1 && x<700 && x<700))
		{
			return 'qqqwqqLjIjKIGn'
		}
		const nrListy=(Math.floor((y%150)/50)*3)+Math.floor((x%150)/50)
		const pozycja=((y%50)*50)+(x%50)
		const uklad=zapisane.widokiUkladow[nrListy][pozycja]
		if (!uklad){return 0}
		if (uklad[0]==y && uklad[1]==x)
		{
			return uklad[2]
		}
	}
	function szukajSzczegolowUkladu(y,x)
	{
		//sos,usługi,
		return {wielkosc:Math.floor(Math.random()*6),kolor:`hsl(${0+Math.floor(Math.random()*60)},${Math.floor(Math.random()*10)+90}%,${Math.floor(Math.random()*50)+50}%)`,nazwa:"test",przesuniecie:Math.floor(Math.random()*9)+1}
	}
	const zapytajSerwer=
	{
		wygladUkladow:function(lista)
		{
			const zwrotka=[]
			for (let a=0 ; a<lista.length ; a++)
			{
				if (!(lista[a][0]>0 && lista[a][1]>0 && lista[a][0]<700 && lista[a][1]<700))
				{
					zwrotka.push('qqqwqqLjIjKIGn')
				}
				else
				{
					zwrotka.push(koduj.wygladUkladu(lista[a][0],lista[a][1],Math.floor(Math.random()*4),Math.floor(Math.random()*9),Math.floor(Math.random()*12),Math.floor(Math.random()*8),"Testowa Nazwa"))
				}
			}
			return setTimeout(()=>{console.log("odpowiedź");odbiorSeerwera.wygladUkladow(zwrotka)},500+Math.random()*5000)
		},
	}
	const odbiorSeerwera=
	{
		wygladUkladow:function(lista)
		{
			console.log(lista.length)
			for (let a=0 ; a<lista.length ; a++)
			{
				const uklad=odkoduj.wygladUkladu(lista[a])
				const nrListy=(Math.floor((uklad.y%150)/50)*3)+Math.floor((uklad.x%150)/50)
				const pozycja=((uklad.y%50)*50)+(uklad.x%50)
				zapisane.widokiUkladow[nrListy][pozycja]=[uklad.y,uklad.x,lista[a]]
			}
		}
	}
</script>
</head>
<body onload="start()">
	<div id="tlo"></div>
	<div id="kontent"></div>
	<div id="sztucznaStopka"></div>
	<div class="pas" id="pas1"><div class="kontentPas"></div></div></div>
	<div class="pas" id="pas2"><div class="kontentPas"></div></div></div>
	<div id="oknoMenu"><div id="tloMenu"></div><div id="ramyMenu"><div id="ramaMenu1"></div><div id="ramaMenu2"></div></div><div id="kontentMenu"></div></div>
</body>
</html>
